# 第16章 3D 凸包の難しさと実装の罠

2次元凸包に比べ、3次元凸包の実装では**落とし穴**が多く、デバッグも難しくなります。この章では、面の可視性判定、Half-edge / DCEL の扱い、退化ケース、法線の向きなど、実装時に直面しやすい問題を整理します。

---

## 16.1 面の可視性判定の不安定性

### 問題

増分構築や Gift Wrapping では、点 $p$ が面 $ABC$ の「どちら側」にあるかを、符号付き体積 $\text{signed\_volume}(A, B, C, p)$ で判定します。

- $\text{signed\_volume} > 0$：$p$ は面の外側（見える）
- $\text{signed\_volume} < 0$：$p$ は面の内側（見えない）
- $\text{signed\_volume} = 0$：$p$ は面上（退化）

浮動小数点演算では、本来 0 に近い値が誤差で正負どちらにもなり得ます。4点がほぼ同一平面上にあるとき、**可視性の判定が反転**し、見える面と見えない面の区別が狂うことがあります。

### 影響

- **誤った面の削除**：見えるはずの面を残す、または見えない面を削除する
- **ホライゾンの破綻**：境界の稜線が正しく求まらず、新面の追加で凸包の形が崩れる
- **無限ループ**：同じ面を繰り返し処理して終わらない

### 対策

1. **eps による 0 判定**：$|\text{signed\_volume}| < \varepsilon$ のときは「面上」とみなし、特別扱いする
2. **入力のスケールに合わせた eps**：座標の桁数に応じて eps を調整する（第9章参照）
3. **有理数・任意精度演算**：重要な判定だけ高精度で行う
4. **Qhull の QJ オプション**：点に微小なランダム摂動を加えて退化を避ける（第17章で詳述）
5. **整数座標**：座標が整数なら、符号付き体積も整数で正確に計算できる

---

## 16.2 Half-edge / DCEL の破損しやすさ

### 整合性の条件

Half-edge と DCEL では、次の不変条件が常に成り立っている必要があります。

- $e.\text{next}.\text{prev} = e$
- $e.\text{twin}.\text{twin} = e$
- $e.\text{origin}$ は $e$ の始点
- 面の境界は、`next` で繋がった**閉じた輪**になっている

面の追加・削除で `next`, `prev`, `twin` を更新する際、1つでも設定を誤ると、これらの条件が崩れます。

### 破損が起きやすい場面

**面の削除時**

- 削除する面の半辺を外すが、隣接面の `next` や `prev` の更新を忘れる
- `twin` が削除された半辺を指したままになる（ dangling reference）

**新面の追加時**

- ホライゾンの半辺と、新しく作る半辺の `twin` を正しく結びつけ忘れる
- 新面の `next` の輪が閉じていない（一周して戻らない）

**ホライゾンの取得時**

- 見える面と見えない面の境界を誤り、ホライゾンが複数の輪に分かれたり、輪になっていなかったりする

### 対策

1. **更新後の整合性チェック**：各操作の後に `e.next.prev == e` などを検査する（デバッグ用）
2. **小さな入力で検証**：四面体や数点で、手計算と照合しながら動作を確認する
3. **段階的な実装**：面の追加のみ先に実装し、削除は後から追加する
4. **既存ライブラリの利用**：CGAL や Qhull など、実績のある実装を参考にする

---

## 16.3 退化ケース（4点が同一平面上）

### 問題

4点 $A$, $B$, $C$, $D$ が同一平面上にあるとき、$\text{signed\_volume}(A, B, C, D) = 0$ となり、四面体が作れません。凸包は**平面図形**（多角形）となり、厚みがなくなります。

### 影響

- **初期四面体が作れない**：増分構築の初期化で、4点が共面だと四面体を構成できない
- **面の選択が不定**：同じ平面上に複数の点があると、「どの3点で面を作るか」が一意でない
- **稜線の重複**：共面する点が多数あると、同じ稜線が複数の面に属するような不正な構造になり得る

### 対策

1. **共面の検出**：4点を選ぶときに $\text{signed\_volume}$ が 0 かどうか確認し、0 なら別の4点を試す
2. **共面点の処理**：同一平面上の点は、その平面内で2次元凸包を求め、得られた多角形の頂点だけを残す
3. **記号摂動**：理論上は、点に微小な摂動を加えて共面を避ける（実装は複雑）
4. **Qhull の QJ オプション**：ジッター（微小なランダム摂動）で共面を解消する

### 実装の指針

```python
def find_initial_tetrahedron(points):
    """4点が共面でない初期四面体を探す"""
    n = len(points)
    for i in range(n):
        for j in range(i+1, n):
            for k in range(j+1, n):
                for l in range(k+1, n):
                    if abs(signed_volume(points[i], points[j], points[k], points[l])) > EPS:
                        return (i, j, k, l)
    return None  # 全点が共面
```

---

## 16.4 法線ベクトルの向きの一貫性

### 問題

凸多面体の各面の法線は、**凸包の外側**を向くように統一する必要があります。向きが混在すると、可視性判定や隣接関係の解釈が逆になり、バグの原因になります。

### 向きの決め方

三角形面 $(A, B, C)$ の法線は $(B-A) \times (C-A)$ で与えられます。頂点の並び順（$A \to B \to C$）によって、法線の向きが反転します。

**一貫性のルール**：

- すべての面で、法線が**外側**を向くようにする
- 外側から見たとき、面の頂点が**反時計回り**に並ぶようにする（右手系）

### 増分構築での注意

新しく追加する面は、ホライゾンの稜線と新しい頂点 $p$ で構成されます。稜線には向きがあり、ホライゾンは「見えない面の側」から「見える面の側」へ進む向きで巡るようにします。このとき、新面 $(a, b, p)$ の頂点順序を、法線が外側を向くように選ぶ必要があります。

**例**：稜線が $a \to b$ の向きで、$p$ がその左側（外側）にあるとき、$(a, b, p)$ の順で頂点を並べると、右手系で法線は外側を向きます。

### デバッグのヒント

- **可視化**：各面の法線を矢印で描画し、すべて外側を向いているか確認する
- **体積の符号**：凸包の「内側」の点で符号付き体積を計算し、すべての面に対して負になることを確認する（法線が外側なら、内側の点は負の側にある）

---

## 本章のまとめ

- **面の可視性判定**は浮動小数点誤差の影響を受けやすく、eps の調整や高精度演算を検討する
- **Half-edge / DCEL** は `next`, `prev`, `twin` の更新を誤ると破損しやすい。整合性チェックを入れるとよい
- **4点が同一平面上**の退化ケースでは、初期四面体の構成や共面点の扱いに注意する
- **法線の向き**を凸包の外側に統一し、頂点の並び順と整合させる

次章からは **Part V：Qhull と高度な話題** に入り、Qhull の内部構造や高次元凸包を扱います。
