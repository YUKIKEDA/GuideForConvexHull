# 第17章 Qhull の内部構造

Qhull は、凸包・Voronoi 図・Delaunay 三角分割などを計算するためのライブラリ兼コマンドラインツールです。学術研究や商用ソフト（MATLAB、SciPy など）で広く利用されています。この章では、Qhull の概要、サポートする構造、アルゴリズムの特徴、オプション、そしてソースコード読解の指針を扱います。

---

## 17.1 Qhull とは

### 概要

**Qhull** は、C.B. Barber らによって開発された計算幾何ライブラリです。凸包、Voronoi 図、Delaunay 三角分割、そしてそれらに付随する構造を、任意次元で計算できます。

- **公式サイト**：https://www.qhull.org/
- **ライセンス**：Qhull License（BSD に近い）
- **言語**：C

### 歴史

- 1990年代前半から開発が始まり、Geometry Center（ミネソタ大学）で利用された
- 現在もメンテナンスが続いており、多くのプロジェクトで採用されている

### 利用分野

- **科学計算**：SciPy（`scipy.spatial.ConvexHull`）、MATLAB、Octave
- **3D 処理**：メッシュ生成、点群処理
- **GIS・可視化**：地形の簡略化、領域の凸包
- **機械学習**：サポートベクトルなど、凸包に関連する計算

---

## 17.2 Qhull がサポートする構造

| 構造 | 説明 | 主なプログラム |
|------|------|----------------|
| **凸包** | 点集合を包む最小の凸集合 | qconvex |
| **Delaunay 三角分割** | 空円条件を満たす三角形分割 | qdelaunay |
| **Voronoi 図** | 各点に最も近い領域の分割 | qvoronoi |
| **ドロネー頂点** | Delaunay の双対としての凸包 | - |

Delaunay 三角分割は、点を抛物面に「持ち上げ」た凸包として計算されるなど、凸包のアルゴリズムが他の構造の基盤になっています。

---

## 17.3 コアアルゴリズムの概要

### QuickHull ベースの設計

Qhull の凸包計算は、**QuickHull** の考え方を基にしています。

- 最遠点で空間を分割し、再帰的に凸包を構築
- 2次元・3次元だけでなく、**4次元以上**にも対応

### 増分構築の要素

点を1つずつ追加し、見える面を削除して新面を追加する**増分構築**の要素も含まれています。衝突情報を利用して、見える面の列挙を効率化しています。

---

## 17.4 入力・出力フォーマット

### 入力形式

標準入力（または `TI` オプションで指定したファイル）から、次の形式で読み込みます。

```
次元
点数
x1 y1 z1 ...    （1点目）
x2 y2 z2 ...    （2点目）
...
```

- 1行目：次元 $d$
- 2行目：点数 $n$
- 3行目以降：各点の座標（$d$ 個の数値、スペース区切り）

コメント行は数値以外で始まります。

### 出力オプション例

| オプション | 内容 |
|------------|------|
| `s` | サマリー（頂点数、面数など） |
| `n` | 各面の超平面（法線とオフセット） |
| `i` | 各面の頂点インデックス |
| `o` | OFF 形式（頂点座標と面のリスト） |
| `p` | 頂点座標のみ |
| `Fv` | 各面の頂点リスト |
| `Fx` | 凸包の頂点（極点）のリスト |
| `FA` | 全表面積と体積 |

### 使用例

```bash
# 10点の3次元凸包、サマリーと OFF 形式で出力
rbox 10 D3 | qconvex s o TO result.off

# 立方体の頂点の凸包、法線を表示
rbox c | qconvex n

# 三角分割出力（Qt）
rbox c | qconvex i Qt
```

---

## 17.5 Qhull のソースコード読解のガイド

### ディレクトリ構成（概要）

- `src/`：コアライブラリ
- `src/libqhull_r/`：スレッドセーフ版（reentrant）
- `src/qconvex/`：凸包のメインプログラム
- `src/libqhull/`：ファセット、頂点、ハイパープレーンなどのデータ構造

### 読む順序の提案

1. **qconvex.c**：凸包プログラムのエントリポイント
2. **qhull.c** や **qhullraux_r.c**：凸包のメイン処理
3. **geom_r.c**：幾何計算（外積、体積など）
4. **qhullraux_r.c**：点の追加処理（`qh_addpoint` など）
5. **poly_r.c**：多面体の構築、ファセットの追加・削除

### 主要な概念

- **facet**：凸包の面（ハイパープレーン、頂点、隣接情報を持つ）
- **ridge**：2つのファセットを隔てる $d-1$ 次元の面（3次元では稜線）
- **visible**：点から「見える」ファセット
- **horizon**：見える面と見えない面の境界

---

## 17.6 Qhull の高度な機能

### オプションフラグの詳細（QJ, Qt など）

| オプション | 説明 | 用途 |
|------------|------|------|
| **Qt** | 三角分割出力。非単体のファセットを三角形に分割する | すべての面を単体（三角形）にしたいとき。退化したゼロ面積の面が出ることがある |
| **QJ** | 入力をジョグル（摂動）する。点に微小なランダム変位を加える | 共面や退化による精度問題を避けたいとき。精度は Qt より落ちる |
| **Qc** | 共面点を保持する | 凸包の辺上の点も出力に含めたいとき |
| **Qi** | 内部点を保持する | 凸包の内部の点も出力に含めたいとき |
| **Qs** | 初期単体を全点から探索する | 退化した入力で初期化に失敗しそうなとき（高コスト） |
| **QRn** | 入力をランダム回転する（シード n） | 最悪ケースを避けたいとき |

**QJ と Qt の使い分け**

- **Qt**：入力を変更せず、出力の面を三角分割する。精度を優先する場合はこちら
- **QJ**：入力点を摂動して退化を避ける。数値的に不安定な入力で使う

### メモリ管理戦略

Qhull は C で実装され、メモリの確保・解放を自前で管理しています。ファセットや頂点は必要なときに動的に確保され、凸包の構築・更新に合わせて解放されます。大規模な入力では、メモリ使用量が計算量とともに増加します。

### 並列化の可能性

公式の Qhull は**シングルスレッド**です。並列化には、入力の分割や、別実装（例：CPU 並列や GPU）の検討が必要です。

---

## 17.7 Qhull のアルゴリズム的特徴の深掘り

### facet merging 戦略

Qhull はデフォルトで**共面するファセットをマージ**します。例えば立方体の8頂点の凸包では、6つの四角形面として出力されます。共面する三角形を1つの多角形面にまとめることで、出力が簡潔になります。

Qt や QJ を使うと、マージを行わず、すべての面を単体（三角形）として出力します。

### visible set の高速探索

点を追加するとき、その点から「見える」ファセットを列挙する必要があります。Qhull では、各ファセットに**衝突している点**の情報を持ち、逆に各点から**見えるファセット**へも参照することで、探索を効率化しています（第14章の衝突グラフに相当）。

### randomized incremental algorithm の要素

点の追加順序を**ランダム**にすると、期待計算量が $O(n \log n)$ になることが知られています。Qhull では、入力のランダム回転（`QRn`）などで、悪い順序を避ける工夫がされています。

### 数値ロバストネスのための工夫（QJ, Qt の背景）

- **QJ**：入力点に微小な摂動を加え、共面や重複を解消する。退化ケースでの失敗を避けられるが、座標がわずかに変わる
- **Qt**：入力はそのままに、出力の面を三角分割する。共面する複数点が1つの面上にある場合、その面上で三角分割を行い、退化した三角形（面積 0）が生じることがある
- **精度パラメータ**：`C-n` や `An` で、許容誤差や半径の基準を指定できる

---

## 本章のまとめ

- **Qhull** は QuickHull を基盤とした凸包・Voronoi・Delaunay のライブラリである
- **Qt**（三角分割）と **QJ**（ジョグル）は、退化や数値誤差への対処オプションである
- ファセットのマージ、衝突グラフによる visible set の高速化、ランダム化の要素が組み込まれている
- ソースコードは `src/libqhull*` を中心に、ファセット・頂点・幾何計算のモジュールで構成される

次章では、**高次元凸包**（4次元以上）の一般化と、ファセット（超平面）の扱いを学びます。
