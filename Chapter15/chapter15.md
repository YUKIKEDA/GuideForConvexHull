# 第15章 データ構造の詳細

3次元凸包を効率的に表現・操作するには、頂点・辺・面の**隣接関係**を適切に管理するデータ構造が必要です。この章では、**Half-edge** と **DCEL（Doubly Connected Edge List）** を紹介し、面の隣接情報をどう扱うかを説明します。

---

## 15.1 Half-edge データ構造

### 基本アイデア

通常、1本の**辺**は2つの頂点を結び、2つの面に挟まれています。Half-edge では、この辺を**向き付きの2本の半辺**に分割し、各半辺が「1つの面の境界をなす有向辺」に対応します。

```
     面 A
   ------->
  /        \
 /   edge   \    通常の辺 → 2本の半辺（逆向き）
 \          /
  \        /
   <------
     面 B
```

### Half-edge の属性

各 **Half-edge**（半辺）は、次の情報を持ちます。

| 属性 | 説明 |
|------|------|
| **origin** | 始点となる頂点 |
| **twin** | 逆方向の半辺（同じ幾何的辺の反対側） |
| **next** | 同じ面の境界上で、この半辺の**次**の半辺 |
| **prev** | 同じ面の境界上で、この半辺の**前**の半辺 |
| **face** | この半辺の**左側**にある面 |

面の境界は半辺の `next` で繋がった輪になり、反時計回り（外側から見て）に巡回できます。

### 図解

```
頂点 v1 ----e---- 頂点 v2
        \      /
         \ f1 /
          \  /
           \/
     半辺: e は v1→v2、face=f1
     e.twin は v2→v1、face=f2

     e.next は v2 から出る次の半辺
     e.prev は v1 に入る前の半辺
```

### 利点

- **隣接面へのアクセス**：`e.twin.face` で隣の面を取得できる
- **面の境界の巡回**：`e.next` を繰り返すと面の全辺を一周できる
- **頂点からの出辺**：各頂点が1本の出る半辺を保持すれば、その頂点に接するすべての辺を巡回できる

---

## 15.2 DCEL（Doubly Connected Edge List）

### 概要

**DCEL**（Doubly Connected Edge List、二重連結辺リスト）は、平面分割や多面体のメッシュを表現するための標準的なデータ構造です。頂点・半辺・面の3種類の要素を、相互に参照できる形で保持します。

### 構成要素

**頂点（Vertex）**

- 座標 $(x, y, z)$
- この頂点を始点とする半辺へのポインタ `incident_edge`（1本あれば、その頂点に接するすべての辺に `twin` と `next` で到達可能）

**半辺（Half-edge）**

- Half-edge 構造と同様：`origin`, `twin`, `next`, `prev`, `face`

**面（Face）**

- この面の境界をなす半辺へのポインタ `outer_component`（外側の輪）
- 穴がある場合は `inner_components`（内側の輪のリスト）

### Half-edge との関係

Half-edge は**辺の表現方法**であり、DCEL は**頂点・辺・面を含む全体のデータ構造**です。DCEL では辺を Half-edge で表現するため、実質的に DCEL = 頂点 + Half-edge + 面、という構成になります。

### 凸包での利用

3次元凸包では、面に穴はないので `inner_components` は不要です。各面は三角形とし、`outer_component` にその三角形の1本の半辺を保持します。増分構築で面を追加・削除する際、Half-edge の `next`, `prev`, `twin` を正しく繋ぎ替えることで、隣接関係を維持できます。

---

## 15.3 面の隣接情報の管理

### 面の隣接とは

凸多面体では、2つの面が**辺を共有**するとき、それらは**隣接**しているといいます。辺 $e$ の両側の面は、`e.face` と `e.twin.face` で得られます。

### 隣接面の列挙

ある面 $f$ に隣接するすべての面を列挙するには、$f$ の境界上の半辺を巡回し、各半辺の `twin.face` を集めます。

```python
def adjacent_faces(face):
    """面 face に隣接する面のリスト"""
    result = []
    start = face.outer_component
    e = start
    while True:
        if e.twin.face is not None:
            result.append(e.twin.face)
        e = e.next
        if e == start:
            break
    return result
```

### ホライゾンの取得

増分構築で点 $p$ を追加するとき、削除する面（見える面）と残す面（見えない面）の境界がホライゾンです。

1. 見える面をすべてマークする
2. 見える面の境界上の半辺のうち、`twin.face` が見えない面であるような半辺を集める

これがホライゾンを構成する稜線となります。各稜線と $p$ を結んで、新しい三角形面を作成します。

### 実装の注意点

- **整合性**：`e.next.prev == e`、`e.twin.twin == e` が常に成り立つようにする
- **面の削除時**：削除する面の半辺を外すとき、残る面の `next`, `prev` の繋ぎ替えを忘れない
- **新面の追加時**：ホライゾンの半辺と、新しく作る半辺の `twin`, `next`, `prev` を正しく設定する

繋ぎ替えを誤ると、データ構造の整合性が崩れ、無限ループや誤った隣接関係の参照につながります（第16章で詳述）。

---

## 本章のまとめ

- **Half-edge** は、1本の辺を2本の有向半辺に分け、`origin`, `twin`, `next`, `prev`, `face` で隣接関係を表現する
- **DCEL** は頂点・半辺・面で構成され、平面分割や多面体メッシュの標準的な表現である
- **面の隣接**は `e.twin.face` で取得でき、ホライゾンは「見える面と見えない面の境界」となる半辺の集合として得られる
- 面の追加・削除時は、半辺の `next`, `prev`, `twin` の整合性を保つことが重要である

次章では、**3次元凸包の難しさと実装の罠**を扱い、面の可視性判定や退化ケース、法線の向きなど、実装時に起こりやすい問題を整理します。
