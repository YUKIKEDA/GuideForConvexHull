# 第14章 3次元 QuickHull と増分構築法

2次元 QuickHull は、最遠点で領域を分割し、再帰的に凸包を構築するアルゴリズムでした。3次元では、**平面**や**四面体**で空間を分割し、同様の分割統治を行います。また、**増分構築法**（点を1つずつ追加して凸包を更新する方法）は、3次元凸包の実装で広く使われており、Qhull の基盤にもなっています。

---

## 14.1 3D QuickHull の概要

### 2次元からの拡張

2次元 QuickHull では：

1. 直線 $\overline{LR}$ で点を上下に分割
2. 各側で最遠点 $P$ を求め、三角形 $\triangle LPR$ の外側の点を再帰処理

3次元では：

1. **初期四面体**を構成する4点を選ぶ（同一直線上・同一平面上でない）
2. 各**面**について、その面から最も遠い点（平面の正の側にある点のうち最遠）を求める
3. その点を凸包の頂点として加え、**見える面**を削除し、**ホライゾン**（見える面と見えない面の境界）に沿って新しい面を追加する
4. 新しい面の「外側」にある点について、再帰的に同様の処理を行う

### 平面からの距離と最遠点

面 $ABC$ と点 $P$ について、符号付き体積 $\text{signed\_volume}(A, B, C, P)$ の絶対値が、平面 $ABC$ から点 $P$ への距離に比例します。平面の「正の側」（凸包の外側）にある点のうち、この絶対値が最大の点が**最遠点**です。

---

## 14.2 増分アルゴリズム（Incremental）

### 点を1つずつ追加し、見える面を削除

増分構築法は、点を1つずつ追加しながら凸包を更新する方法です。

**アルゴリズムの流れ**

1. **初期化**：4点が同一直線上・同一平面上でない初期四面体を構成し、これを凸包とする
2. **点の追加**：残りの点 $p$ を1つ選ぶ
3. **可視面の判定**：凸包の面のうち、$p$ から**見える**面（$p$ が面の外側にある面）をすべて求める
4. **面の削除**：見える面を削除する
5. **ホライゾン**：削除された面と残った面の境界が**ホライゾン**（稜線のループ）をなす
6. **新面の追加**：ホライゾンの各稜線と $p$ を結んで、新しい三角形面を追加する
7. **繰り返し**：すべての点を処理するまで 2〜6 を繰り返す

```
点 p を追加
    p •
     /|\
    / | \   見える面（斜線）を削除
   /  |  \  ホライゾンに沿って
  /   |   \  p と結ぶ新面を追加
 •----+----•
  \   |   /
   \  |  /
    \ | /
     \|/
      •
```

### 「見える」とは

面 $ABC$ に対し、法線を凸包の**外側**に向けておきます。点 $p$ が $\text{signed\_volume}(A, B, C, p) > 0$ のとき、$p$ は面の**外側**にあり、この面は $p$ から**見える**（visible）といいます。$p$ が凸包の内側にある場合は、どの面からも見えません。

---

## 14.3 衝突グラフと効率的な面削除

### 衝突（Conflict）とは

増分構築で点 $p$ を追加するとき、「$p$ から見える面」をすべて特定する必要があります。素朴には全面について $\text{signed\_volume}$ を計算しますが、点や面が増えると非効率です。

**衝突**：面 $f$ と点 $p$ が**衝突**しているとは、$p$ が $f$ の外側にある（$f$ は $p$ から見える）ことをいいます。

### 衝突グラフ

**衝突グラフ**（conflict graph）は、面と点の衝突関係を管理するデータ構造です。

- 各**面**に対して、その面と衝突している（外側にある）**点のリスト**を保持する
- 各**点**に対して、その点から見える**面のリスト**を保持する（双方向に持つ場合もある）

**利点**

- 点 $p$ を追加するとき、$p$ に紐づく「見える面」のリストから、削除すべき面をすぐに得られる
- 新しく追加した面について、どの点が衝突しているかを、削除した面の衝突点リストを継承することで効率的に更新できる

### 面削除の効率化

増分構築で、点 $p$ を追加する際の処理：

1. $p$ の衝突面リストから、見える面をすべて取得
2. これらの面を削除し、ホライゾン（削除面と残存面の境界）を求める
3. ホライゾンの各稜線と $p$ から新面を作成
4. 削除した面に衝突していた点のうち、新面のいずれかと衝突する点を、新面の衝突リストに配分する

ランダムな順序で点を追加すると、期待計算量は $O(n \log n)$ になることが知られています（Randomized Incremental Construction）。

---

## 14.4 Qhull で使われているアイデアの前振り

Qhull は QuickHull を基盤とした凸包ライブラリで、次のような工夫が組み込まれています。

### QuickHull ベースの設計

- 3次元 QuickHull の分割統治的な構造
- 最遠点による面の分割と再帰

### 増分構築の要素

- 点を逐次追加する処理
- 衝突情報の利用（実装の詳細は Qhull のソースに依存）

### その他の工夫

- **ファセットのマージ**：共面する三角形を大きな多角形面にまとめる（出力の簡素化）
- **数値ロバストネス**：QJ（ジッター）や Qt（三角化）などのオプションで、退化ケースや数値誤差に対処
- **高次元対応**：4次元以上の凸包にも対応

第17章で、Qhull の内部構造とオプションをより詳しく扱います。

---

## 本章のまとめ

- **3次元 QuickHull** は、平面や四面体で空間を分割し、最遠点を凸包の頂点として追加しながら再帰する
- **増分構築法** は、点を1つずつ追加し、見える面を削除してホライゾンに沿って新面を追加する
- **衝突グラフ** により、見える面の列挙や衝突点の継承を効率化できる
- **Qhull** は QuickHull と増分構築の考え方を組み合わせ、数値安定性や高次元対応などの工夫を加えている

次章では、**Half-edge** や **DCEL** といったデータ構造を学び、3次元凸包の効率的な表現と操作の基盤を押さえます。
